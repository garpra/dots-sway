#!/usr/bin/env bash
set -euo pipefail

# VARIABEL
OUTPUT_DIR="$HOME/Videos/Recording"
WF_PID="/tmp/wf-record.pid"
MIC_PID="/tmp/mic-record.pid"

AUDIO_INTERNAL="alsa_output.pci-0000_00_1f.3-platform-skl_hda_dsp_generic.HiFi__Headphones__sink.monitor"
AUDIO_MIC="alsa_input.pci-0000_00_1f.3-platform-skl_hda_dsp_generic.HiFi__Mic1__source"

FRAMERATE=30

# Icons + Colors
ICON_ON="󰻃"
ICON_OFF="󰙦"
COLOR_ON="#9ece6a"
COLOR_OFF="#f7768e"

mkdir -p "$OUTPUT_DIR"

# Fungsi untuk cek apakah rekaman sudah dimulai
is_recording() {
    [[ -f "$WF_PID" || -f "$MIC_PID" ]]
}

save_pid() {
    echo "$!" >"$1"
}

# Fungsi mematikan pid
kill_pid() {
    local pidfile="$1"
    [[ ! -f "$pidfile" ]] && return

    local pid
    pid=$(cat "$pidfile")

    kill -SIGTERM "$pid" 2>/dev/null || true
    sleep 0.2

    if kill -0 "$pid" 2>/dev/null; then
        kill -SIGUSR1 "$pid" 2>/dev/null || true
    fi

    if kill -0 "$pid" 2>/dev/null; then
        kill -9 "$pid" 2>/dev/null || true
    fi

    wait "$pid" 2>/dev/null || true
    rm -f "$pidfile"
}

notify() {
    notify-send "Recording" "$1"
}

timestamp() {
    date +%Y%m%d_%H%M%S
}

# Fungsi untuk memulai rekaman
start_recording() {
    if is_recording; then
        notify "Already recording!"
        exit 0
    fi

    local ts file mic
    ts=$(timestamp)
    file="$OUTPUT_DIR/rec_${ts}.mkv"
    mic="$OUTPUT_DIR/rec_${ts}_mic.wav"

    (
        exec wf-recorder \
            --file "$file" \
            --audio "$AUDIO_INTERNAL" \
            --framerate "$FRAMERATE" \
            >/dev/null 2>&1
    ) &
    save_pid "$WF_PID"

    ffmpeg -loglevel error -y \
        -f pulse -i "$AUDIO_MIC" \
        -ac 1 -ar 48000 -c:a pcm_s16le "$mic" &
    save_pid "$MIC_PID"

    notify "Started"
}

# Fungsi untuk memtikan rekaman
stop_recording() {
    kill_pid "$WF_PID"
    kill_pid "$MIC_PID"
    notify "Stopped"
}

# Fungsi untuk menampilkan status ke waybar
show_status() {
    if is_recording; then
        echo "<span color=\"$COLOR_ON\">$ICON_ON</span>"
    else
        echo "<span color=\"$COLOR_OFF\">$ICON_OFF</span>"
    fi
}

# Menu rofi
show_menu() {
    if is_recording; then
        printf "$ICON_OFF  Stop Recording" |
            rofi -dmenu -p "Recording" | grep -q Stop && stop_recording
    else
        printf "$ICON_ON  Start Recording" |
            rofi -dmenu -p "Recording" | grep -q Start && start_recording
    fi
}

case "${1:-}" in
--status) show_status ;;
*) show_menu ;;
esac
