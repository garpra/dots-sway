#!/bin/bash

OUTPUT_DIR="$HOME/Videos/Recording"
mkdir -p "$OUTPUT_DIR"

WF_PID="/tmp/wf-record.pid"
MIC_PID="/tmp/mic-record.pid"

# Device audio (monitor dan mic - sudah benar untuk laptopmu)
AUDIO_INTERNAL="alsa_output.pci-0000_00_1f.3-platform-skl_hda_dsp_generic.HiFi__Headphones__sink.monitor"
AUDIO_MIC="alsa_input.pci-0000_00_1f.3-platform-skl_hda_dsp_generic.HiFi__Mic1__source"

ON_COLOR="#9ece6a"
OFF_COLOR="#f7768e"
ICON_ON="󰻃"
ICON_OFF=""

# ===== STATUS ===== #
get_status() {
    if [[ -f "$WF_PID" || -f "$MIC_PID" ]]; then
        echo "<span color=\"$ON_COLOR\">$ICON_ON</span>"
    else
        echo "<span color=\"$OFF_COLOR\">$ICON_OFF</span>"
    fi
}

# ===== STOP ===== #
stop_recording() {
    for pidfile in "$WF_PID" "$MIC_PID"; do
        [[ ! -f "$pidfile" ]] && continue
        pid=$(cat "$pidfile")

        kill -SIGINT "$pid" 2>/dev/null
        sleep 0.5
        kill -9 "$pid" 2>/dev/null

        rm -f "$pidfile"
    done

    notify-send "Recording" "Stopped"
}

# ===== START ===== #
start_recording() {
    if [[ -f "$WF_PID" || -f "$MIC_PID" ]]; then
        notify-send "Recording" "Already recording!"
        return
    fi

    ts=$(date +%Y%m%d_%H%M%S)
    VIDEO="$OUTPUT_DIR/rec_${ts}.mkv"
    MIC="$OUTPUT_DIR/rec_${ts}_mic.wav"

    # ======= VIDEO + INTERNAL AUDIO (wf-recorder) =======
    wf-recorder -f "$VIDEO" \
        --audio="$AUDIO_INTERNAL" \
        --codec libx264 \
        --preset veryfast \
        --crf 23 \
        --pixel-format yuv420p \
        --framerate 30 \
        2>/dev/null &
    echo $! >"$WF_PID"

    # ======= MIC AUDIO (ffmpeg raw wav) =======
    ffmpeg -loglevel quiet -y \
        -f pulse -i "$AUDIO_MIC" \
        -ac 1 -ar 48000 -c:a pcm_s16le "$MIC" &
    echo $! >"$MIC_PID"

    notify-send "Recording" "Started"
}

# ===== MENU ===== #
menu() {
    if [[ -f "$WF_PID" || -f "$MIC_PID" ]]; then
        choice=$(printf "$ICON_OFF  Stop Recording" |
            rofi -dmenu -p "Recording" -theme ~/.config/rofi/menu.rasi)
        [[ "$choice" == "$ICON_OFF  Stop Recording" ]] && stop_recording
    else
        choice=$(printf "$ICON_ON  Start Recording" |
            rofi -dmenu -p "Recording" -theme ~/.config/rofi/menu.rasi)
        [[ "$choice" == "$ICON_ON  Start Recording" ]] && start_recording
    fi
}

# ===== ENTRY ===== #
case "$1" in
--status) get_status ;;
*) menu ;;
esac
