#!/bin/bash

# VARIABLE
ON_COLOR="#9ece6a"
OFF_COLOR="#f7768e"
SERVICE_OFF_COLOR="#545c7e"

ICON_ON="󰂯"
ICON_OFF="󰂲"
ICON_MGR="󰂱"
ICON_SVC="󰂰"

# Fungsi untuk memberikan status ke waybar
get_status() {
    if ! systemctl -q is-active bluetooth.service; then
        echo "<span color=\"$SERVICE_OFF_COLOR\">$ICON_OFF</span>"
        return
    fi

    bt_powered=$(bluetoothctl show | grep -Po '(?<=Powered: )\w+' 2>/dev/null)
    if [[ "$bt_powered" == "yes" ]]; then
        echo "<span color=\"$ON_COLOR\">$ICON_ON</span>"
    else
        echo "<span color=\"$OFF_COLOR\">$ICON_OFF</span>"
    fi
}

main_menu() {
    if systemctl -q is-active bluetooth.service; then

        powered=$(bluetoothctl show | grep -Po '(?<=Powered: )\w+' 2>/dev/null)
        if [[ "$powered" == "yes" ]]; then
            toggle="$ICON_OFF Disable Bluetooth"
            cmd="power off"
        else
            toggle="$ICON_ON Enable Bluetooth"
            cmd="power on"
       fi

       choice=$(printf "%s\n%s\n%s" \
            "$toggle" "$ICON_MGR Manage Bluetooth" "$ICON_SVC Disable Service" \
            | rofi -dmenu -p "Bluetooth:" -theme ~/.config/rofi/menu.rasi)

        case "$choice" in
            "$toggle")
                bluetoothctl <<< "$cmd"
                notify-send "Bluetooth" "Bluetooth $(echo $cmd | awk '{print $2}')"
                ;;
            "$ICON_MGR Manage Bluetooth")
                blueman-manager &
                ;;
            "$ICON_SVC Disable Service")
                pkexec systemctl disable --now bluetooth.service
                notify-send "Bluetooth" "Service disabled"
                ;;
        esac
    
    else
        choice=$(echo "$ICON_SVC Enable Service" \
            | rofi -dmenu -p "Bluetooth:" -theme ~/.config/rofi/menu.rasi)

        [[ "$choice" ]] && pkexec systemctl start bluetooth.service \
            && notify-send "Bluetooth" "Service enabled"
    fi
}

case $1 in
    --status) get_status ;;
    *) main_menu ;;
esac

