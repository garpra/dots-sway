#!/bin/bash

# Konfigurasi
INTERVAL=0.1                             # Interval klik (detik)
PIDFILE="/tmp/ydotool_clicker.pid"
SOCKET_PATH="/run/user/$UID/.ydotool_socket"
TOGGLE=0                                 # 1 = Aktif, 0 = Nonaktif

# Fungsi: Start ydotoold
start_ydotoold() {
    echo "Check ydotoold..."

    # Jika ydotoold sudah berjalan
    if pgrep -x ydotoold >/dev/null; then
        echo "ydotoold already running."

        # Jika socket hilang â†’ restart
        if [ ! -S "$SOCKET_PATH" ]; then
            echo "Socket not found, restart ydotoold..."
            pkill ydotoold
            sleep 0.5
        else
            return 0
        fi
    fi

    echo "Start ydotoold..."
    mkdir -p "/run/user/$UID"

    sudo ydotoold \
        --socket-path="$SOCKET_PATH" \
        --socket-own="$UID:$GID" &

    # Tunggu socket muncul
    for _ in {1..20}; do
        [ -S "$SOCKET_PATH" ] && {
            echo "ydotoold successfully executed."
            return 0
        }
        sleep 0.5
    done

    echo "ERROR: Failed to start ydotoold."
    exit 1
}

# Fungsi: Toggle Autoclicker
toggle_click() {
    TOGGLE=$((1 - TOGGLE))
    [[ $TOGGLE -eq 1 ]] && echo "Autoclicker: ON" || echo "Autoclicker: OFF"
}

# Fungsi: Cleanup saat exit
cleanup() {
    echo "Stop autoclicker..."
    rm -f "$PIDFILE"
    exit 0
}

# Setup Signals
trap "toggle_click" SIGUSR1
trap "cleanup" SIGINT SIGTERM EXIT

# Simpan PID
echo $$ > "$PIDFILE"

# Mulai ydotoold
start_ydotoold

# Info untuk user
cat <<EOF
Autoclicker ready to use.
PID: $$
Socket: $SOCKET_PATH
Initial status: OFF
EOF

# Main Loop Autoclicker
while true; do
    if (( TOGGLE == 1 )); then

        # Pastikan socket tersedia
        if [ -S "$SOCKET_PATH" ]; then
            YDOTOOL_SOCKET="$SOCKET_PATH" ydotool click 0xC0 &>/dev/null
        else
            echo "ERROR: Socket lost, trying to start ydotoold..."
            start_ydotoold
        fi
    fi

    sleep "$INTERVAL"
done
